@{
    // Thiết lập Layout = null vì đây là file Layout chính
    Layout = null;

    // Lấy thông tin từ Session an toàn hơn
    var currentUserID = Session["UserID"]?.ToString();

    // Sử dụng 'as string' để đảm bảo nó là chuỗi và tránh lỗi NullReference
    var currentFullName = Session["Username"] as string;

    // Nếu Session["FullName"] bị null hoặc rỗng, đặt nó về null để logic kiểm tra dễ dàng hơn
    if (string.IsNullOrEmpty(currentFullName))
    {
        currentFullName = null;
    }
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>@ViewBag.Title</title>
    <link rel="stylesheet" href="~/Content/style.css" />
    <script src="~/Content/Script.js" defer></script>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="@Url.Action("Index", "Home")" class="logo-link">
                <img src="~/Image/Icon/Logo.png" alt="NetTruyen Logo" class="logo-img">
            </a>

            <div class="search-bar-wrapper">
                <input id="searchInput" type="text" placeholder="Tìm truyện..." class="search-input">
                <button id="searchButton" class="search-button" aria-label="Tìm kiếm">
                    <img src="~/Image/Icon/search.png" alt="Icon tìm kiếm" class="header-icon-img">
                </button>
            </div>
            <ul id="searchResults"
                style="list-style:none;padding:0;margin-top:10px;text-align:left;max-height:400px;overflow-y:auto;border:1px solid #ddd;border-radius:5px;display:none;">
            </ul>

            <div class="header-icons">
                <a href="#" class="icon-link" aria-label="đèn" id="theme-toggle">
                    <img src="~/Image/Icon/light.png" alt="đèn" class="header-icon-img" id="light-toggle-icon">
                </a>
                <a href="#" class="icon-link" aria-label="Tin nhắn">
                    <img src="~/Image/Icon/messenger.png" alt="Icon Tin nhắn" class="header-icon-img">
                </a>
                
                <div class="account-dropdown">
                    @* Nút trigger dropdown *@
                    <a href="#" class="icon-link" aria-label="Tài khoản">
                        <img src="~/Image/Icon/user.png" alt="Icon Tài khoản" class="header-icon-img user-icon">

                        @* HIỂN THỊ TÊN HOẶC CHỮ 'Tài khoản' *@
                        @if (!string.IsNullOrEmpty(currentFullName))
                        {
                            <span class="user-display-name">@currentFullName</span>
                        }
                        else
                        {
                            <span class="user-display-name">Tài khoản</span>
                        }
                    </a>

                    <div class="dropdown-menu">
                        @* NỘI DUNG MENU THẢ XUỐNG DỰA TRÊN TRẠNG THÁI ĐĂNG NHẬP *@
                        @if (!string.IsNullOrEmpty(currentUserID))
                        {
                            @* ĐÃ ĐĂNG NHẬP: Hiển thị Profile, Truyện theo dõi, Đăng xuất *@
                            <a href="#">
                                <img src="~/Image/Icon/user.png" alt="Hồ sơ" class="header-icon-img user-icon">Hồ sơ
                            </a>
                            <a href="#">
                                <i class="fa fa-heart header-icon-img user-icon"></i>Truyện theo dõi
                            </a>
                            <a href="@Url.Action("Logout", "Account")">
                                <img src="~/Image/Icon/logout.png" alt="Đăng xuất" class="header-icon-img user-icon">Đăng xuất
                            </a>
                        }
                        else
                        {
                            @* CHƯA ĐĂNG NHẬP: Hiển thị Đăng nhập và Đăng ký *@
                            <a href="@Url.Action("Login", "Account")">
                                <img src="~/Image/Icon/user.png" alt="Icon Tài khoản" class="header-icon-img user-icon">Đăng nhập
                            </a>
                            <a href="@Url.Action("Register", "Account")">
                                <img src="~/Image/Icon/user.png" alt="Icon Tài khoản" class="header-icon-img user-icon">Đăng ký
                            </a>
                        }
                    </div>
                </div>
                <!-- END: Khối Tài khoản/Đăng nhập -->
            </div>
        </div>
    </header>

    <nav class="main-nav">
        <div class="nav-inner">
            <ul>
                <li><a href="#"><img src="~/Image/Icon/home.png" alt="Icon Tài khoản" class="header-icon-img user-icon"></a></li>
                <li><a href="#">HOT</a></li>
                <li><a href="#">THEO DÕI</a></li>
                <li><a href="#">LỊCH SỬ</a></li>
                <li class="nav-has-submenu">
                    <a href="#">THỂ LOẠI <span class="arrow-down">▼</span></a>
                    <div class="nav-submenu">
                        <ul>
                            <li><a href="#">Hành động</a></li>
                            <li><a href="#">Tình cảm</a></li>
                            <li><a href="#">Hài hước</a></li>
                            <li><a href="#">Phiêu lưu</a></li>
                            <li><a href="#">Kinh dị</a></li>
                            <li><a href="#">Trinh thám</a></li>
                            <li><a href="#">Học đường</a></li>
                            <li><a href="#">Viễn tưởng</a></li>
                            <li><a href="#">Thể thao</a></li>
                            <li><a href="#">Xuyên không</a></li>
                            <li><a href="#">Manhwa</a></li>
                            <li><a href="#">Manhua</a></li>
                        </ul>
                    </div>
                </li>
                <li><a href="#">TÌM TRUYỆN</a></li>
                <li><a href="#">MANHUA</a></li>
                <li><a href="#">MANHWA</a></li>
                <li><a href="#">NGÔN TÌNH</a></li>
                <li><a href="#">CON GÁI</a></li>
                <li><a href="#">CON TRAI</a></li>
                <li><a href="#">BLOG</a></li>
            </ul>
        </div>
    </nav>


    <div class="main-container">
        @RenderBody()
    </div>

    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-col footer-col-info">
                <a href="#" class="logo-link">
                    <img src="~/Image/Icon/Logo.png" alt="NetTruyen Logo" class="logo-img">
                </a>
                <div class="footer-links-group">
                    <a href="#">Giới thiệu</a> | <a href="#">Liên hệ</a>
                </div>
                <div class="footer-links-group">
                    <a href="#">Điều khoản</a> | <a href="#">Chính sách Bảo mật</a>
                </div>
                <div class="footer-contact">
                    <p><strong>Liên hệ đặt quảng cáo</strong></p>
                    <p>Email: <a href="mailto:ads@nettruyen.com">ads@nettruyen.com</a></p>
                </div>
                <p class="copyright">Copyright © 2025 NetTruyen</p>
            </div>

            <div class="footer-col footer-col-menu">
                <div class="tag-group">
                    <a href="#">Truyện tranh</a>
                    <a href="#">NetTruyen</a>
                    <a href="#">Truyện tranh online</a>
                    <a href="#">Đọc truyện tranh online</a>
                    <a href="#">Truyện Tranh Đam Mỹ</a>
                    <a href="#">Truyện Tranh Ngôn Tình</a>
                    <a href="#">VietTruyen Ngôn Tình</a>
                    <a href="#">Manhwa</a>
                    <a href="#">Manhua</a>
                    <a href="#">VNtruyen.com</a>
                    <a href="#">animevietsub</a>
                    <a href="#">truyện con gái</a>
                </div>
            </div>

            <div class="footer-col footer-col-disclaimer">
                <h4>Miễn trừ trách nhiệm</h4>
                <p class="disclaimer-text">
                    Trang web của chúng tôi cung cấp truyện tranh từ nhiều nguồn khác nhau với mục đích chia sẻ và giải trí. Chúng tôi không sở hữu hoặc đảm bảo bản quyền của các tác phẩm được đăng tải. Nếu bạn là chủ sở hữu bản quyền và cho rằng nội dung vi phạm quyền lợi của mình, vui lòng liên hệ để chúng tôi gỡ bỏ ngay lập tức.
                </p>
                <p class="disclaimer-text">
                    Ngoài ra, chúng tôi không chịu trách nhiệm về bất kỳ quảng cáo nào được hiển thị trên trang. Các quảng cáo này do bên thứ ba cung cấp và chúng tôi không kiểm soát nội dung, chất lượng hay tính xác thực của sản phẩm, dịch vụ được quảng cáo. Người dùng cần tự đánh giá và chịu trách nhiệm khi quyết định tương tác với các quảng cáo đó.
                </p>
            </div>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const $input = $('#searchInput');
        const $results = $('#searchResults');
        let timeout = null;

        $input.on('input', function () {
            const keyword = $(this).val().trim();

            clearTimeout(timeout);

            if (!keyword) {
                $results.hide().empty();
                return;
            }

            timeout = setTimeout(() => {
                $.getJSON('/Search/LiveSearch', { keyword }, function (data) {
                    $results.empty();

                    if (data.results.length === 0) {
                        $results.append('<li style="padding:10px;">Không tìm thấy kết quả</li>').show();
                        return;
                    }

                    data.results.forEach(story => {
                        const item = `
                            <li style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #eee;">
                                <a href="/Story/Detail/${story.StoryID}"
                                   style="display:flex;align-items:center;gap:10px;text-decoration:none;color:#333;">
                                    <img src="${story.CoverImage}" alt="${story.Title}"
                                         style="width:50px;height:70px;object-fit:cover;border-radius:4px;">
                                    <div>
                                        <h4 style="margin:0;font-size:14px;">${story.Title}</h4>
                                        <small style="color:#777;">Tác giả: ${story.Author}</small>
                                    </div>
                                </a>
                            </li>`;
                        $results.append(item);
                    });

                    $results.show();
                });
            }, 300); // đợi 0.3s sau khi ngừng gõ
        });
    </script>

</body>
</html>
